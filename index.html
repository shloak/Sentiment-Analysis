<head>
  <script src="//www.parsecdn.com/js/parse-1.6.7.min.js"></script>
</head>

<body>
  <h2 style="text-align:center;">Visual Affect Labeling</h2>
  <p style="text-align:center;"> This website is being used to amass a dataset about human emotion within images. For each image you see, here's what you'll need to do: <br>
1. Verify whether existing emotion tags are  relevant (all images may not have existing tags) <br>
2. Identify how many <strong> primary participants </strong> there are and what they are doing <br>
3. Add unique emotion tags (words/phrases) of your own <br>
4. Categorize whether this image is good for emotion tagging <br>
You can view the data <a href="http://shloak.github.io/VALData">here</a>. Thank you for your help! <br><br>
<strong>primary participant:</strong> someone whose face is clearly shown in focus or is a primary actor in the event, and whose emotion can be reasoned. 

 </p>
  <p id="startButtonPara" style="text-align:center;">
    <button onclick="startButton()">Begin!</button>
  </p>
  <img id="image" style="display:none; margin-left: auto; margin-right: auto;" />
  <div id="tagPara" style="display: none; text-align:center;">
    <h4 id="tagview"> </h4> Is this a good tag?
    <input type="radio" name="tags" id="yesTag">Yes
    <input type="radio" name="tags" id="noTag">No
    <button onclick="nextTagClick()">Next Tag</button>
  </div>
  <br>
  <div id="questionsPara" style="display:none; text-align:center;">
    <br> How many primary participants are there:
    <input type="radio" name="people" id="people_zero">0
    <input type="radio" name="people" id="people_one">1
    <input type="radio" name="people" id="people_two">2
    <input type="radio" name="people" id="people_three">3
    <input type="radio" name="people" id="people_four">4 or more
    <br>
    <br> What is he/she doing:
    <input type = "text" name="actionInput" id="actionInput">
    <br> <br>
    New tags for emotion:
    <input type="text" name="answer" id="answer">
    <button onclick="addTag()">Add</button> <br>
    <i>Press the add button after each new tag. Please go one at a time. </i>
    <br>
    <br> Is this a good image for this task:
    <input type="radio" name="good" id="good_yes">Yes
    <input type="radio" name="good" id="good_no">No
    <br>
    <br>
    <button onclick="nextPicClick()">Next Picture</button>
  </div>
</body>
<script>
  Parse.initialize("p4tWFy9DoQKEKAxKNycBu3QH6htzRcZDzMw1ywFa", "kg3IFa5DBIGXraX5hegFsSM29giG1btPM3wUvxpN");
  var currentObj = [];
  //var currentTags;
  var currentIndexObj = 0;
  var currentIndexTag = 0;

  function startButton() {
    document.getElementById("startButtonPara").style.display = "none";
    document.getElementById("tagPara").style.display = "block";
    GetParse();
  }

  function GetParse() {
    var VALData = Parse.Object.extend("VALData");
    var query = new Parse.Query(VALData);
    query.limit(500);
    //query.skip(5);
    //query.exists("tag");
    query.find({
      success: function(results) {
        //alert("Successfully retrieved " + results.length + " objects.");
        //alert(results[0].get("imageId"));
        currentObj = results.slice(0, results.length);
        currentObj = shuffle(currentObj);
        //console.log('currentObj[0].get("tag")', currentObj[0].get("tag"));
        if (currentObj[currentIndexObj].get("tag") == null) {
          displayQuestions();
        } else {
          showTag();
        }
        document.getElementById("image").src = "http://mscoco.org/images/" + currentObj[currentIndexObj].get("imageId");
        document.getElementById("image").style.display = "block";
      },
      error: function(error) {
        alert("Error: " + error.code + " " + error.message);
      }
    });
  }

  function shuffle(array) {
    var currentIndex = array.length,
      temporaryValue, randomIndex;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }

    return array;
  }

  function nextTagClick() {
    var currentArr;
    if (document.getElementById("yesTag").checked || document.getElementById("noTag").checked) {
      if (document.getElementById("yesTag").checked) {
        //alert("entered good");
        currentArr = currentObj[currentIndexObj].get("goodTag");
        currentArr[currentIndexTag]++;
        currentObj[currentIndexObj].set("goodTag", currentArr);
        currentObj[currentIndexObj].save();
        //alert("saved good");
      } else if (document.getElementById("noTag").checked) {
        //alert("entered bad");
        currentArr = currentObj[currentIndexObj].get("badTag");
        currentArr[currentIndexTag]++;
        currentObj[currentIndexObj].set("badTag", currentArr);
        currentObj[currentIndexObj].save();
        //alert("saved bad");
      }
      uncheck();
      if (currentIndexTag < (currentObj[currentIndexObj].get("tag").length - 1))
        currentIndexTag++;
      else {
        currentIndexTag = 0;
        displayQuestions();
      }
      showTag();
    } else
      alert("You haven't selected an option.");
  }

  function displayQuestions() {
    document.getElementById("tagPara").style.display = "none";
    document.getElementById("questionsPara").style.display = "block";
  }

  function uncheck() {
    document.getElementById("yesTag").checked = false;
    document.getElementById("noTag").checked = false;
    var ele = document.getElementsByName("people");
    for (var i = 0; i < ele.length; i++)
      ele[i].checked = false;
    ele = document.getElementsByName("good");
    for (var i = 0; i < ele.length; i++)
      ele[i].checked = false;
  }

  function showTag() {
    if (currentIndexTag < currentObj[currentIndexObj].get("tag").length) {
      document.getElementById("tagview").innerHTML = currentObj[currentIndexObj].get("tag")[currentIndexTag];
      //alert(currentTags[currentIndexTag]);
    } else {
      document.getElementById("tagview").innerHTML = "no more";
      currentIndexTag = 0;
      //next
    }
  }

  function addTag() {
    var currString = document.getElementById("answer").value;
    var currArr;
    var exists = true;
    if (currString.length > 2) {
      currArr = currentObj[currentIndexObj].get("tag");
      if (currArr == null) {
        currentObj[currentIndexObj].add("tag", currString);
        currentObj[currentIndexObj].add("goodTag", 0);
        currentObj[currentIndexObj].add("badTag", 0);
        currentObj[currentIndexObj].save();
        document.getElementById("answer").value = "";
      } else {
        for (var i = 0; i < currArr.length; i++) {
          if (currArr[i] == currString) {
            exists = false;
          }
        }
        if (exists) {
          currentObj[currentIndexObj].add("tag", currString);
          currentObj[currentIndexObj].add("goodTag", 0);
          currentObj[currentIndexObj].add("badTag", 0);
          currentObj[currentIndexObj].save();
          document.getElementById("answer").value = "";
        } else {
          alert("This tag already exists");
        }
      }
    } else
      alert("Invalid tag");
  }

  function saveParse() {
    //alert("parse save enter");
    currentObj[currentIndexObj].add("numPeople", findNumPpl());
    currentObj[currentIndexObj].add("goodPic", findGoodPic());
    currentObj[currentIndexObj].add("action", findAction());
    currentObj[currentIndexObj].save();
    //alert("parse saved exit");
  }

  function nextPicClick() {
    if (fitsRequired()) {
      saveParse();
      document.getElementById("actionInput").value = "";
      document.getElementById("answer").value = "";
      currentIndexObj++;
      currentIndexTag = 0;
      uncheck();
      document.getElementById("image").src = "http://mscoco.org/images/" + currentObj[currentIndexObj].get("imageId");
      if (currentObj[currentIndexObj].get("tag") == null) {
        displayQuestions();
      } else {
        document.getElementById("tagPara").style.display = "block";
        document.getElementById("questionsPara").style.display = "none";
        showTag();
      }
    }
  }

  function fitsRequired() {
    if (findNumPpl() == "not checked") {
      alert('No primary participants option checked');
      return false;
    }
    if (findAction() == "noAction") {
      alert('No action inputted');
      return false;
    }
    if (findGoodPic() == "not checked") {
      alert('No good image option checked');
      return false;
    }
    return true;
  }

  function findAction() {
    var curr = document.getElementById("actionInput").value;
    if (curr.length > 3)
    {
      return curr;
    }
    else
      return "noAction";
  }

  function findNumPpl() {
    if (document.getElementById("people_zero").checked)
      return 0;
    else if (document.getElementById("people_one").checked)
      return 1;
    else if (document.getElementById("people_two").checked)
      return 2;
    else if (document.getElementById("people_three").checked)
      return 3;
    else if (document.getElementById("people_four").checked)
      return 4;
    return "not checked";
  }

  function findGoodPic() {
    if (document.getElementById("good_yes").checked)
      return "yes";
    else if (document.getElementById("good_no").checked)
      return "no";
    return "not checked";
  }

</script>
